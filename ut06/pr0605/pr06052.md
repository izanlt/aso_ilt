$logCrudo = @"
[INFO] ID:8842 :: 2023/11/01_10:00 :: User:admin_01 :: Action:Login_Success
[ERROR] ID:9921 :: 2023/11/01_10:05 :: User:guest_user :: Action:Auth_Fail (Pass)
[WARN] ID:8843 :: 2023-11-01 10:15 :: User:dev_team :: Action:Upload_Limit_Exceeded
[CRITICAL] ID:1001 :: 01-11-2023_10:20 :: User:ROOT :: Action:Service_Stop
"@ -split"`r`n"

$objetosprocesados = foreach ($linea in $logcrudo) {
    if ($linea.StartsWith("[INFO]")) { continue }
    $partes = $linea -split "::"
    $nivel = $partes[0].split(']')[0].Replace('[', ").Trim()
    $id = $partes[0].split(':')[1].Trim()
    $fechalimpia = $partes[1].Replace('-', '/').Replace('_',' ')
    $timestamp = (Get-date $fechalimpia).ToString("yyy-MM-dd hh:mm")

    $usuario = $partes[2].split(':').Trim().ToLower()

    if ($usuario -eq "ROOT") { $usuario = "administrador" }

    $action = partes[3].split(':')[].Trim()

    [PSCustomObject]@{
        TimeStamp = $timestamp
        Severity = $nivel
        User = $usuario
        EventID = $id
        Action = $action
    }
}

$objetosprocesados | Export-Csv -Path "reporte_seguridad.csv"
$objetosprocesados | Format-Table -AutoSize